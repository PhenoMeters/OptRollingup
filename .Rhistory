min_num_trypsin_sites = min_num_trypsin_sites
)
get_masking_pattern_proportions = function(masking_pattern_set, mu = 0){
unifs = runif(length(masking_pattern_set))
unifs = rnorm(length(masking_pattern_set), mu)
proportions = unifs / sum(unifs)
return(proportions)
}
masking_pattern_set = create_masking_set(full_masking, n_masking_patterns)
g1_masking_pattern_proportions = n_masking_patterns:1 / sum(1:n_masking_patterns)
g2_masking_pattern_proportions = 1:n_masking_patterns / sum(1:n_masking_patterns)
expected_fc = g1_masking_pattern_proportions / g2_masking_pattern_proportions
g1_dat = simulate_proteins_for_group(
n_subjects = n_g1,
group_id = 1,
n_reps = n_protein_replicates,
masking_set = masking_pattern_set,
masking_proportions = g1_masking_pattern_proportions,
full_masking = full_masking,
pk_missed_prop = proteinase_k_missed_prob,
tr_missed_prop = trypsin_missed_prob,
sequences = synthetic_protein,
pk_prob = NULL,
tr_prob = NULL,
pk_mu = pk_mu,
tr_mu = tr_mu)
g2_dat = simulate_proteins_for_group(
n_subjects = n_g2,
group_id = 2,
n_reps = n_protein_replicates,
masking_set = masking_pattern_set,
masking_proportions = g2_masking_pattern_proportions,
full_masking = full_masking,
pk_missed_prop = proteinase_k_missed_prob,
tr_missed_prop = trypsin_missed_prob,
sequences = synthetic_protein,
pk_prob = NULL,
tr_prob = NULL,
pk_mu = pk_mu,
tr_mu = tr_mu)
full_pep_data = get_full_pep_data(g1_dat, g2_dat)
full_cleavage_mapping = get_full_cleavage_mapping(g1_dat, g2_dat)
f_data = generate_f_data(full_pep_data)
#add missingness capabilities here
site_res = get_site_res(full_pep_data, full_cleavage_mapping, functions[[function_idx]])
site_plot_res = create_site_plot(site_res, masking_pattern_set)
site_p = site_plot_res$p
site_line_data = site_plot_res$line_data
tryptic_res = get_tryptic_res(full_pep_data, full_cleavage_mapping)
tryptic_plot_res = create_tryptic_plot(tryptic_res, masking_pattern_set)
tryptic_p = tryptic_plot_res$p
tryptic_line_data = tryptic_plot_res$line_data
plot_data = tryptic_plot_res$plot_data
tmp_res = get_comparison_results(site_line_data, tryptic_line_data, plot_data, full_masking)
compare_p = tmp_res$p
res = tmp_res$res %>%
mutate(
replicate = r,
n_per_group = sim_dat$n_per_group[i],
n_protein_replicates = n_protein_replicates,
trypsin_missed_prob = trypsin_missed_prob,
proteinase_k_missed_prob = proteinase_k_missed_prob,
overall_missingness = full_pep_data %>% dplyr::select(-peptide, -protein, -start_site) %>% apply(., 1, \(x) mean(is.na(x))) %>% mean(),
sd_across_peptides = full_pep_data %>% dplyr::select(-peptide, -protein, -start_site) %>% apply(., 1, \(x) mean(is.na(x))) %>% sd(),
max_masked_region_size = max_masked_region_size,
gap_parameter = gap_parameter,
aggregation_method = names(functions)[function_idx]
) %>%
rbind(res, .)
saveRDS(res, here::here("Out", "sim_res", "lip_rollup_sims.RDS"))
# ggsave(here::here("Out", "plots", paste0("comparison_",r, ".png")), compare_p, width = 14, height = 6)
# ggsave(here::here("Out", "plots", paste0("tryptic_lineplot_",r, ".png")), tryptic_p, width = 14, height = 6)
# ggsave(here::here("Out", "plots", paste0("site_lineplot_",r, ".png")), site_p, width = 14, height = 6)
}
}
library(ggplot2)
library(dplyr)
library(OrgMassSpecR)
library(pmartR)
library(tidyverse)
source(here::here("code_to_migrate", "ptm_utils.R"))
source(here::here("code_to_migrate", "LiP_utils.R"))
source(here::here("code_to_migrate", "missing_data_utils.R"))
# Create amino acid distribution
lip_data = readr::read_tsv(here::here("Data", "double_pept_lytic_sites.tsv"))
all_peptides = unlist(lapply(lip_data$Sequence, \(x) strsplit(x, split = '; ')[[1]]))
unique_peptides = unique(all_peptides)
amino_acids = unlist(lapply(unique_peptides, \(x) strsplit(x, split = "")[[1]]))
amino_acid_distribution = create_amino_acid_distribution(amino_acids)
# Tuning parameters for protein masking
set.seed(70)
sample_delay = function() rpois(1, 10)
downsample_fn = function(vec, prop) sample(vec, floor(prop * length(vec)))
min_num_trypsin_sites = 5
n_masking_patterns = 2
sequence_length = 1000
pk_mu = 8
tr_mu = 3
#stuff I want to change
n_per_group_vec = c(5, 10, 25, 50)
n_protein_replicates_vec = c(100, 500, 1000)
trypsin_missed_prob_vec = c(0, 0.25, 0.5)
proteinase_k_missed_prob_vec = c(0, 0.25, 0.5)
max_masked_region_size_vec = c(25)
gap_parameter_vec = c(50)
functions = list(
'mean' = mean,
'median' = median,
'sum' = sum
)
library(ggplot2)
library(dplyr)
library(OrgMassSpecR)
library(pmartR)
library(tidyverse)
source(here::here("code_to_migrate", "ptm_utils.R"))
source(here::here("code_to_migrate", "LiP_utils.R"))
source(here::here("code_to_migrate", "missing_data_utils.R"))
# Create amino acid distribution
lip_data = readr::read_tsv(here::here("Data", "double_pept_lytic_sites.tsv"))
all_peptides = unlist(lapply(lip_data$Sequence, \(x) strsplit(x, split = '; ')[[1]]))
unique_peptides = unique(all_peptides)
amino_acids = unlist(lapply(unique_peptides, \(x) strsplit(x, split = "")[[1]]))
amino_acid_distribution = create_amino_acid_distribution(amino_acids)
# Tuning parameters for protein masking
set.seed(70)
sample_delay = function() rpois(1, 10)
downsample_fn = function(vec, prop) sample(vec, floor(prop * length(vec)))
min_num_trypsin_sites = 5
n_masking_patterns = 2
sequence_length = 1000
pk_mu = 8
tr_mu = 3
#stuff I want to change
n_per_group_vec = c(50)
n_protein_replicates_vec = c(1000)
trypsin_missed_prob_vec = c(0.25)
proteinase_k_missed_prob_vec = c(0.25)
max_masked_region_size_vec = c(25)
gap_parameter_vec = c(50)
functions = list(
'mean' = mean,
'median' = median,
'sum' = sum
)
sim_dat = expand.grid(
n_per_group = n_per_group_vec,
trypsin_missed_prob = trypsin_missed_prob_vec,
proteinase_k_missed_prob = proteinase_k_missed_prob_vec,
n_protein_replicates = n_protein_replicates_vec,
max_masked_region_size = max_masked_region_size_vec,
gap_parameter = gap_parameter_vec,
function_idx = seq_along(functions)
)
n_reps = 30
sim_dat
#stuff I want to change
n_per_group_vec = c(50)
n_protein_replicates_vec = c(1000)
trypsin_missed_prob_vec = c(0.25)
proteinase_k_missed_prob_vec = c(0.25)
max_masked_region_size_vec = c(25)
gap_parameter_vec = c(50)
sim_dat = expand.grid(
n_per_group = n_per_group_vec,
trypsin_missed_prob = trypsin_missed_prob_vec,
proteinase_k_missed_prob = proteinase_k_missed_prob_vec,
n_protein_replicates = n_protein_replicates_vec,
max_masked_region_size = max_masked_region_size_vec,
gap_parameter = gap_parameter_vec,
)
sim_dat = expand.grid(
n_per_group = n_per_group_vec,
trypsin_missed_prob = trypsin_missed_prob_vec,
proteinase_k_missed_prob = proteinase_k_missed_prob_vec,
n_protein_replicates = n_protein_replicates_vec,
max_masked_region_size = max_masked_region_size_vec,
gap_parameter = gap_parameter_vec
)
n_reps = 30
#iterate though replicates
res = c()
r = 1
i = 1
#get scenario parameters
n_g1 = sim_dat$n_per_group[i]
n_g2 = sim_dat$n_per_group[i]
n_protein_replicates = sim_dat$n_protein_replicates[i]
trypsin_missed_prob = sim_dat$trypsin_missed_prob[i]
proteinase_k_missed_prob = sim_dat$proteinase_k_missed_prob[i]
max_masked_region_size = sim_dat$max_masked_region_size[i]
gap_parameter = sim_dat$gap_parameter[i]
function_idx = sim_dat$function_idx[i]
sample_gap = function() rpois(1, gap_parameter)
#Generate one synthetic protein
synthetic_protein = generate_protein(sequence_length, amino_acid_distribution)
# Perform full masking
full_masking = mask_sequence(
sequence = synthetic_protein,
delay_fn = sample_delay,
gap_fn = sample_gap,
max_masked_region_size = max_masked_region_size,
min_num_trypsin_sites = min_num_trypsin_sites
)
get_masking_pattern_proportions = function(masking_pattern_set, mu = 0){
unifs = runif(length(masking_pattern_set))
unifs = rnorm(length(masking_pattern_set), mu)
proportions = unifs / sum(unifs)
return(proportions)
}
masking_pattern_set = create_masking_set(full_masking, n_masking_patterns)
g1_masking_pattern_proportions = n_masking_patterns:1 / sum(1:n_masking_patterns)
g2_masking_pattern_proportions = 1:n_masking_patterns / sum(1:n_masking_patterns)
expected_fc = g1_masking_pattern_proportions / g2_masking_pattern_proportions
g1_dat = simulate_proteins_for_group(
n_subjects = n_g1,
group_id = 1,
n_reps = n_protein_replicates,
masking_set = masking_pattern_set,
masking_proportions = g1_masking_pattern_proportions,
full_masking = full_masking,
pk_missed_prop = proteinase_k_missed_prob,
tr_missed_prop = trypsin_missed_prob,
sequences = synthetic_protein,
pk_prob = NULL,
tr_prob = NULL,
pk_mu = pk_mu,
tr_mu = tr_mu)
g1_masking_pattern_proportions
g1_dat
g1_dat$peptide_df |> view
g1_dat$peptide_df |> view()
g2_dat = simulate_proteins_for_group(
n_subjects = n_g2,
group_id = 2,
n_reps = n_protein_replicates,
masking_set = masking_pattern_set,
masking_proportions = g2_masking_pattern_proportions,
full_masking = full_masking,
pk_missed_prop = proteinase_k_missed_prob,
tr_missed_prop = trypsin_missed_prob,
sequences = synthetic_protein,
pk_prob = NULL,
tr_prob = NULL,
pk_mu = pk_mu,
tr_mu = tr_mu)
full_pep_data = get_full_pep_data(g1_dat, g2_dat)
full_cleavage_mapping = get_full_cleavage_mapping(g1_dat, g2_dat)
f_data = generate_f_data(full_pep_data)
full_pep_data
full_cleavage_mapping
f_data
full_cleavage_mapping
sim_dat
sim_dat |>
mutate(
scenario_id = 1
)
f_data
out = list(pep_data = full_pep_data, cleavage_mapping = full_cleavage_mapping, metadata = f_data, sim_data = tibble(scenario_id = i, replicate = r))
out
paste0(i, "_", r, ".RDS")
saveRDS(out, here::here("synthetic_data", paste0("lip_", i, "_", r, ".RDS"))
}
here::here("synthetic_data", paste0("lip_", i, "_", r, ".RDS"))
source("~/Library/CloudStorage/OneDrive-PNNL/Documents/project_files/ppi_systems/workspace/Code/proteosim/R/generate_lip_data_for_jorda.R", echo=TRUE)
library(OrgMassSpecR)
library(tidyverse)
library(pmartR)
here::i_am("code_to_migrate/ptm_simulation_and_dials.Rmd")
source(here::here("code_to_migrate", "protein_quant2.R"))
source(here::here("code_to_migrate", "ptm_utils.R"))
source(here::here("code_to_migrate", "TMT_simulation", "Code", "utils.R"))
#things to change
samples_per_group_vec = c(10, 30, 50)
n_synth_proteins_vec = c(5, 10)
total_abundance_vec = c(100, 250)
protein_sequence_length_vec = c(100, 200)
site_sd_vec = c(0, 1) # sd on generating normal coefficients for site effects
subject_sd_vec = c(0, 1) # sd on generating normal coefficients for subject effects
prop_to_miss_vec = c(0, 0.25, 0.5)
missingness_prop_vec = c(0, 0.25, 0.5)
library(OrgMassSpecR)
library(tidyverse)
library(pmartR)
here::i_am("code_to_migrate/ptm_simulation_and_dials.Rmd")
source(here::here("code_to_migrate", "protein_quant2.R"))
source(here::here("code_to_migrate", "ptm_utils.R"))
source(here::here("code_to_migrate", "TMT_simulation", "Code", "utils.R"))
#things to change
samples_per_group_vec = c(50)
n_synth_proteins_vec = c(10)
total_abundance_vec = c(100)
protein_sequence_length_vec = c(1000)
site_sd_vec = c(0.1) # sd on generating normal coefficients for site effects
subject_sd_vec = c(0.1) # sd on generating normal coefficients for subject effects
prop_to_miss_vec = c(0)
missingness_prop_vec = c(0)
# So do we have DA proteins across groups and DA site modifications?
# Can probably confirm this by just simulating some data and checking
#misc
samples_per_plex = 4
sim_scenarios = expand.grid(
n_synth_proteins = n_synth_proteins_vec,
total_abundance = total_abundance_vec,
protein_sequence_length = protein_sequence_length_vec,
site_sd = site_sd_vec,
subject_sd = subject_sd_vec,
prop_to_miss = prop_to_miss_vec,
missingness_prop = missingness_prop_vec,
samples_per_group = samples_per_group_vec
)
n_reps = 2
out_dat = c()
set.seed(42)
rr = 1
ss = 1
tryCatch({
# Set scenario parameters
n_synth_proteins <- sim_scenarios$n_synth_proteins[ss]
total_abundance <- sim_scenarios$total_abundance[ss]
site_sd <- sim_scenarios$site_sd[ss]
protein_sequence_length <- sim_scenarios$protein_sequence_length[ss]
subject_sd <- sim_scenarios$subject_sd[ss]
prop_to_miss <- sim_scenarios$prop_to_miss[ss]
missingness_prop <- sim_scenarios$missingness_prop[ss]
samples_per_group <- sim_scenarios$samples_per_group[ss]
sequences <- sapply(seq_len(n_synth_proteins), \(x) generate_random_protein(protein_sequence_length))
n_plex = (2 * samples_per_group) / samples_per_plex
# Get protein data
out <- tryCatch({
get_samples_for_sequences(
sequences = sequences,
sequence_abundances = rbind(
round(rbeta(n_synth_proteins, 3, 3) * total_abundance),
round(rbeta(n_synth_proteins, 3, 3) * total_abundance)
) %>% t(),
samps_per_group = samples_per_group,
site_sd = site_sd,
subject_sd = subject_sd,
prop_to_miss = prop_to_miss,
amino_acid = "S",
identifier = "@"
)
}, error = function(e) {
message(sprintf("Error in get_samples_for_sequences at rr = %d, ss = %d: %s", rr, ss, e$message))
NULL
})
if (is.null(out)) next
pepdat <- out$pepdat
ground_truth_site <- out$ground_truth_site
ground_truth_site_pattern <- out$ground_truth_site_pattern
# Pre-process data
pepdat <- assign_plexes(pepdat, samples_per_plex, n_plex)
pepdat <- pmartR::edata_transform(pepdat, "log2")
pepdat <- pmartR::normalize_global(pepdat, subset_fn = 'all', norm_fn = "median", apply_norm = TRUE, backtransform = FALSE)
tryCatch({
pepdat <- pmartR::applyFilt(pmartR::molecule_filter(pepdat), pepdat, min_num = 2)
pepdat <- pmartR::applyFilt(pmartR::proteomics_filter(pepdat), pepdat, min_num_peps = 2)
}, error = function(e) {
message(sprintf("Error in filtering at rr = %d, ss = %d: %s", rr, ss, e$message))
})
saveRDS(out_dat, here::here("synthetic_data", paste0("lip_", ss, "_", rr, ".rds")))
}, error = function(e) {
message(sprintf("Error in outer loop rr = %d, ss = %d: %s", rr, ss, e$message))
})
saveRDS(pepdat, here::here("synthetic_data", paste0("lip_", ss, "_", rr, ".rds")))
saveRDS(pepdat, here::here("synthetic_data", paste0("ptm_", ss, "_", rr, ".rds")))
pepdat
source("~/Library/CloudStorage/OneDrive-PNNL/Documents/project_files/ppi_systems/workspace/Code/proteosim/R/generate_ptm_data_for_jorda.R", echo=TRUE)
source("~/Library/CloudStorage/OneDrive-PNNL/Documents/project_files/ppi_systems/workspace/Code/proteosim/R/generate_ptm_data_for_jorda.R", echo=TRUE)
library(ggplot2)
library(dplyr)
library(OrgMassSpecR)
library(pmartR)
library(tidyverse)
source(here::here("code_to_migrate", "ptm_utils.R"))
source(here::here("code_to_migrate", "LiP_utils.R"))
source(here::here("code_to_migrate", "missing_data_utils.R"))
######################################################
### Simulation
######################################################
# Create amino acid distribution
lip_data = readr::read_tsv(here::here("Data", "double_pept_lytic_sites.tsv"))
all_peptides = unlist(lapply(lip_data$Sequence, \(x) strsplit(x, split = '; ')[[1]]))
unique_peptides = unique(all_peptides)
amino_acids = unlist(lapply(unique_peptides, \(x) strsplit(x, split = "")[[1]]))
amino_acid_distribution = create_amino_acid_distribution(amino_acids)
# Tuning parameters for protein masking
set.seed(70)
sample_delay = function() rpois(1, 10)
downsample_fn = function(vec, prop) sample(vec, floor(prop * length(vec)))
min_num_trypsin_sites = 5
n_masking_patterns = 2
sequence_length = 1000
pk_mu = 8
tr_mu = 3
#stuff I want to change
n_per_group_vec = c(50)
n_protein_replicates_vec = c(1000)
trypsin_missed_prob_vec = c(0.25)
proteinase_k_missed_prob_vec = c(0.25)
max_masked_region_size_vec = c(25)
gap_parameter_vec = c(50)
functions = list(
'mean' = mean,
'median' = median,
'sum' = sum
)
sim_dat = expand.grid(
n_per_group = n_per_group_vec,
trypsin_missed_prob = trypsin_missed_prob_vec,
proteinase_k_missed_prob = proteinase_k_missed_prob_vec,
n_protein_replicates = n_protein_replicates_vec,
max_masked_region_size = max_masked_region_size_vec,
gap_parameter = gap_parameter_vec,
function_idx = seq_along(functions)
)
n_reps = 30
#iterate though replicates
res = c()
r = 1
i = 1
#get scenario parameters
n_g1 = sim_dat$n_per_group[i]
n_g2 = sim_dat$n_per_group[i]
n_protein_replicates = sim_dat$n_protein_replicates[i]
trypsin_missed_prob = sim_dat$trypsin_missed_prob[i]
proteinase_k_missed_prob = sim_dat$proteinase_k_missed_prob[i]
max_masked_region_size = sim_dat$max_masked_region_size[i]
gap_parameter = sim_dat$gap_parameter[i]
function_idx = sim_dat$function_idx[i]
sample_gap = function() rpois(1, gap_parameter)
#Generate one synthetic protein
synthetic_protein = generate_protein(sequence_length, amino_acid_distribution)
# Perform full masking
full_masking = mask_sequence(
sequence = synthetic_protein,
delay_fn = sample_delay,
gap_fn = sample_gap,
max_masked_region_size = max_masked_region_size,
min_num_trypsin_sites = min_num_trypsin_sites
)
get_masking_pattern_proportions = function(masking_pattern_set, mu = 0){
unifs = runif(length(masking_pattern_set))
unifs = rnorm(length(masking_pattern_set), mu)
proportions = unifs / sum(unifs)
return(proportions)
}
masking_pattern_set = create_masking_set(full_masking, n_masking_patterns)
g1_masking_pattern_proportions = n_masking_patterns:1 / sum(1:n_masking_patterns)
g2_masking_pattern_proportions = 1:n_masking_patterns / sum(1:n_masking_patterns)
expected_fc = g1_masking_pattern_proportions / g2_masking_pattern_proportions
expected_fc
g1_dat = simulate_proteins_for_group(
n_subjects = n_g1,
group_id = 1,
n_reps = n_protein_replicates,
masking_set = masking_pattern_set,
masking_proportions = g1_masking_pattern_proportions,
full_masking = full_masking,
pk_missed_prop = proteinase_k_missed_prob,
tr_missed_prop = trypsin_missed_prob,
sequences = synthetic_protein,
pk_prob = NULL,
tr_prob = NULL,
pk_mu = pk_mu,
tr_mu = tr_mu)
g1_dat
g2_dat = simulate_proteins_for_group(
n_subjects = n_g2,
group_id = 2,
n_reps = n_protein_replicates,
masking_set = masking_pattern_set,
masking_proportions = g2_masking_pattern_proportions,
full_masking = full_masking,
pk_missed_prop = proteinase_k_missed_prob,
tr_missed_prop = trypsin_missed_prob,
sequences = synthetic_protein,
pk_prob = NULL,
tr_prob = NULL,
pk_mu = pk_mu,
tr_mu = tr_mu)
full_pep_data = get_full_pep_data(g1_dat, g2_dat)
full_cleavage_mapping = get_full_cleavage_mapping(g1_dat, g2_dat)
f_data = generate_f_data(full_pep_data)
full_pep_data
full_cleavage_mapping
site_res = get_site_res(full_pep_data, full_cleavage_mapping, functions[[function_idx]])
site_res
site_res = get_site_res(full_pep_data, full_cleavage_mapping, functions[[function_idx]])
install.packages('stringr')
install.packages("stringr")
library(stringr)
site_res = get_site_res(full_pep_data, full_cleavage_mapping, functions[[function_idx]])
full_masking
masking_pattern_set
full_cleavage_mapping
full_pep_data
tryptic_res = get_tryptic_res(full_pep_data, full_cleavage_mapping)
masking_pattern_set
expected_fc
expected_fc
full_cleavage_mapping
full_pep_data
full_cleavage_mapping
masking_pattern_set
site_res
full_pep_data
full_cleavage_mapping
source("~/Library/CloudStorage/OneDrive-PNNL/Documents/project_files/ppi_systems/workspace/Code/proteosim/R/generate_lip_data_for_jorda.R", echo=TRUE)
source("~/Library/CloudStorage/OneDrive-PNNL/Documents/project_files/ppi_systems/workspace/Code/proteosim/R/generate_lip_data_for_jorda.R", echo=TRUE)
